CXX := g++
RELEASE := 1

OPT := -Wall -fopenmp
ifeq ($(RELEASE),1)
OPT += -O3
else
OPT += -g
endif

NAME := flip2d
DEBUG := 0
BINDIR := bin
SRCDIR := src
SRC := $(shell find $(SRCDIR) -name "*.cpp")
HEADER := $(shell find $(SRCDIR) -name "*.h")
INC	:= $(addprefix -I , $(shell find $(SRCDIR) -name ".svn" -prune -o -type d)) -I /opt/local/include
ARCH := $(shell uname)
SUM	= $(shell find . -name "*.h" -print0 -o -name "*.cpp" -print0 | xargs -0 wc -l | grep total )

ifeq ($(ARCH),Darwin)
	LIB := -framework OpenGL -framework GLUT -fopenmp /opt/local/lib/libgsl.a /opt/local/lib/libgslcblas.a
endif

ifeq ($(ARCH),Linux)
	LIB := -lglut -lGLEW -fopenmp
endif

all:
	@make depend
	@make $(BINDIR)/$(NAME) DEP=1
	@echo "\nLine sum: ${SUM}"

$(BINDIR)/$(NAME) : $(SRC:.cpp=.o)
	@$(CXX) -o $@ $(SRC:.cpp=.o) $(LIB) $(OPT)
	@echo "Linking $@..."

run: all
	$(BINDIR)/$(NAME)

depend : $(SRC:.cpp=.d)
%.d : %.cpp
	@echo "$@ $(dir $@)$$(gcc $(INC) -MM -MG $<)" > $@

%.o : %.cpp
	@$(CXX) $(OPT) $(INC) -o $@ -c $<
	@echo "Compiling $< ..."

.PHONY: clean
clean:
	rm -rf $(shell find . -name "*.o" -o -name "*.d")
	rm -rf $(BINDIR)/$(NAME)
	rm -rf GPATH GRTAGS GSYMS GTAGS HTML

ifeq ($(DEP), 1)
-include $(SRC:.cpp=.d)
endif
